# awsのpqc対応について

## 1. PQCとは

### Post-Quantum Cryptography（耐量子計算機暗号）

量子コンピュータによる解読を防ぐ次世代の暗号技術

### なぜ今対応が必要なのか

**"Harvest Now, Decrypt Later" 攻撃のリスク**
1. 現在: 暗号化された通信を記録・保存
2. 将来: 量子コンピュータで解読

**問題点:**
- 現在の暗号（RSA、ECDHE等）は量子コンピュータで解読可能に
- 機密性の高いデータ（個人情報、医療記録等）は長期間保護が必要
- 量子コンピュータの実用化を待ってからでは遅い

### PQCアルゴリズムの特徴
- 量子コンピュータでも解読が困難な数学的問題に基づく
- NIST（米国標準技術研究所）が2024年に標準化
- 主なアルゴリズム: ML-KEM（旧Kyber）、ML-DSA（旧Dilithium）など

## 2. tlsについて
### 暗号スイートの構成要素
例：ECDHE-RSA-AES128-GCM-SHA256

- **鍵交換 (ECDHE)**: クライアントとサーバーが暗号鍵を安全に共有する方法
  - 楕円曲線ディフィー・ヘルマン鍵交換を使用
  - 第三者に傍受されても鍵が漏れない

- **認証 (RSA)**: 通信相手（サーバー）が本物かを確認
  - デジタル証明書による認証
  - 中間者攻撃を防ぐ

- **共通鍵暗号 (AES128-GCM)**: 実際のデータの暗号化
  - 128ビット鍵のAES（Advanced Encryption Standard）
  - GCMモードで認証付き暗号化

- **ハッシュ (SHA256)**: データの改ざん検知とメッセージ認証
  - 256ビットのハッシュ値を生成
  - データの完全性を保証

## 3. TLSハンドシェーク
### 暗号スイートの決定プロセス

1. **Client Hello**: クライアントが対応する暗号スイートのリストを送信
2. **Server Hello**: サーバーが自身が対応する暗号スイートの中から選択
3. **選択基準**: 両者が対応する暗号スイートの中で最も強力なものを優先
   - サーバー側のポリシーで優先順位を設定可能
   - セキュリティレベルの高いものから順に評価

## 4. TLS1.2とTLS1.3の違い
### ハンドシェークの高速化

**TLS 1.2**: 2ラウンドトリップ（2-RTT）
```
Client → Server: Client Hello
Client ← Server: Server Hello, Certificate, Key Exchange
Client → Server: Key Exchange, Change Cipher Spec, Finished
Client ← Server: Change Cipher Spec, Finished
[ここから暗号化通信開始]
```

**TLS 1.3**: 1ラウンドトリップ（1-RTT）
```
Client → Server: Client Hello + Key Share
Client ← Server: Server Hello, Certificate, Finished
[ここから暗号化通信開始]
```

### 主な改善点
- ハンドシェークが半分の時間に短縮
- 不要な暗号スイートの削除（脆弱なものを廃止）
- よりシンプルで安全な設計

## 5. PQCの適用箇所
### TLSにおける適用ポイント

暗号スイートの4要素のうち、**鍵交換アルゴリズム**にPQCが適用される

- **鍵交換**: 従来のECDHE → PQCアルゴリズム（ML-KEM等）に置き換え
- **認証**: RSA/ECDSAは当面そのまま（将来的にPQC署名アルゴリズムへ移行予定）
- **共通鍵暗号**: AESは量子コンピュータに対しても比較的安全
- **ハッシュ**: SHA-2/SHA-3は当面安全

### なぜ鍵交換が優先されるのか
"Harvest Now, Decrypt Later"攻撃への対策が最優先
- 現在の通信を記録しておき、将来の量子コンピュータで解読する攻撃
- 鍵交換が破られると、過去の通信すべてが危険に晒される

## 6. AWSのPQC対応方針

### ハイブリッド暗号方式の採用

AWSは従来のアルゴリズム（ECDHE）とPQCアルゴリズムを**併用**する方式を採用

**ハイブリッドの仕組み:**
```
最終的な共有鍵 = ECDHE鍵 + PQC鍵（ML-KEM等）
```

### ハイブリッド方式を採用する理由

1. **リスクヘッジ**: PQCアルゴリズムが将来破られても、ECDHEが健在なら安全性を維持
2. **後方互換性**: 既存システムとの相互運用性を保ちながら段階的に移行
3. **標準化の途上**: PQCアルゴリズムは2024年にNISTが標準化したばかり
   - 十分な実績と検証が必要
   - 予期しない脆弱性が発見される可能性

### 段階的な移行計画
- Phase 1: ハイブリッドモードでの運用開始（現在）
- Phase 2: PQCアルゴリズムの実績評価
- Phase 3: 将来的にPQC単体への移行を検討

## 7. 対応する時に考えること

### サーバとクライアントを分けて考える

**重要**: 自社システムでは**サーバ側のみの対応**で十分

### 一般的なALB-ECS構成での役割

```
[ユーザー]
    ↓ HTTPS (インバウンド)
   [ALB] ← サーバとして動作、TLS終端（PQC対応必要）
    ↓ HTTP
   [ECS]
    ↓ HTTPS (アウトバウンド)
[NAT Gateway]
    ↓
[外部API] ← クライアントとして動作（PQC対応不要）
```

### 役割ごとの対応方針

**インバウンド（ユーザー → ALB）:**
- ALBがサーバとしてTLS終端
- **PQC対応が必要**
- ユーザーのブラウザがPQC対応していれば、自動的にPQCが使われる

**アウトバウンド（ECS → 外部API）:**
- ECSタスクがクライアントとして動作
- **PQC対応は不要**（接続先サーバー次第）
- 外部APIがPQC対応していれば自動的に使われるが、こちら側で設定する必要はない

## 8. CloudFrontの対応

### デフォルトで有効

CloudFrontは**すでにPQC対応が完了**しており、追加設定は不要

**対応内容:**
- すべてのCloudFrontディストリビューションで自動的にPQC対応
- TLS 1.3を使用している場合、PQC対応暗号スイートが自動的に有効
- ユーザー側で設定変更する必要なし

**確認方法:**
- ブラウザの開発者ツールで接続情報を確認
- PQC対応ブラウザからアクセスすると、PQC暗号スイートが使われる

## 9. ALBの対応

### PQC対応セキュリティポリシー

AWSが提供するPQC対応ポリシーを適用するだけでOK

**主なポリシー例:**
- `ELBSecurityPolicy-TLS13-1-2-2021-06` (従来のTLS 1.2, 1.3ポリシー)
- `ELBSecurityPolicy-TLS13-1-2-PQ-2025-09` (TLS 1.2, 1.3 + PQC)

### 互換性について

**後方互換性あり:**
- 既存のポリシーに**PQC対応の暗号スイートが追加されるのみ**
- PQC非対応クライアントは従来通りの暗号スイートを使用
- 既存の通信に影響なし

**PQC対応クライアントの場合:**
- 自動的にPQC対応暗号スイートがネゴシエーションされる
- ブラウザ等が対応していれば、何もしなくてもPQCで通信される

### 設定方法
1. ALBのリスナー設定を開く
2. セキュリティポリシーをPQC対応ポリシーに変更
3. 保存するだけ

## 10. 気を付けること

### トラフィック少ない時間帯に更新

AWS公式ドキュメントより:
> セキュリティポリシーを更新すると、ロードバランサーが大量のトラフィックを処理している場合に中断が発生する可能性があります。

**推奨:**
- 深夜・早朝などの低トラフィック時間帯に実施
- メンテナンス時間として事前告知
- 可能であればBlue/Green デプロイメントを検討

### 複数セキュアリスナーの問題

**問題:**
- 同一ALBに複数のHTTPSリスナー（異なるポート）がある場合
- リスナー間でセキュリティポリシーに**互換性が求められる**
- 従来のTLSポリシーとPQC対応ポリシーは**互換性なし**

**発生する問題:**
```
リスナー1: 従来ポリシー (ELBSecurityPolicy-TLS13-1-2-2021-06)
リスナー2: PQC対応ポリシー (ELBSecurityPolicy-TLS13-1-2-PQ-2025-09)
→ 片方の更新が他方にブロックされ、手動でもTerraformでも更新不可能
```

**回避策:**
- 現時点では有効な回避策が見つかっていない
- 複数のHTTPSリスナーを使用している場合は注意が必要
- 可能であれば、最初からPQC対応ポリシーで構築することを推奨

## 11. まとめ

### PQC対応の要点
- 量子コンピュータ時代に備えた暗号化対策
- AWSではハイブリッド方式で安全に移行可能
- CloudFrontは自動対応済み、ALBは設定変更のみでOK

### 今すぐできること
1. CloudFront: すでに対応済み（確認のみ）
2. ALB: セキュリティポリシーをPQC対応版に更新
3. 低トラフィック時間帯に実施

### 今後の展望
- PQCの実績評価が進む
- 将来的にはPQC単体への移行も検討
- 他のAWSサービスも順次対応予定

## 12. 参考資料

- [AWS: Post-quantum TLS now supported in AWS KMS](https://aws.amazon.com/blogs/security/post-quantum-tls-now-supported-in-aws-kms/)
- [NIST Post-Quantum Cryptography Standardization](https://csrc.nist.gov/projects/post-quantum-cryptography)
- [AWS ELB セキュリティポリシー](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/create-https-listener.html#describe-ssl-policies)
